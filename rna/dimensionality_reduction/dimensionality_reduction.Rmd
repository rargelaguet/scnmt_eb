---
title: "scNMT EB: dimensionality reduction on RNA data"
---
  
```{r load_modules, echo=FALSE, include=FALSE}
library(SingleCellExperiment)
library(scran)
library(RColorBrewer)
library(umap)
```

```{r define_opts, echo=FALSE}
source("/Users/ricard/scnmt_eb/settings.R")
io$outdir <- paste0(io$basedir, "/rna/dimensionality_reduction")

## Define options ##

# Define which cells to use
opts$day_lineage <- c(
  
  # Day 2
  "Day2_Epiblast",
  "Day2_Primitive Streak",
  
  # Day 4/5
  "Day4-5_Epiblast",
  "Day4-5_Primitive Streak",
  "Day4-5_Mesoderm",
  
  # Day 6/7
  "Day6-7_Mesoderm",
  "Day6-7_Endoderm",
  "Day6-7_Blood"
)

# Define which genotypes to use 
opts$genotype <- c(
  "WT",
  "KO"
)
```

Update sample metadata
```{r}
sample_metadata <- sample_metadata %>% 
  .[pass_rnaQC==T & day_lineage%in%opts$day_lineage & genotype%in%opts$genotype]
```

Load RNA expression data as a SingleCellExperiment object
```{r load_data, echo=FALSE}
sce <- readRDS(io$rna)[,sample_metadata$id_rna]

rownames(sce) <- rowData(sce)$symbol
```

Select HVG
```{r}
decomp <- modelGeneVar(sce)
decomp <- decomp[decomp$mean > 0.01,]
hvgs <- rownames(decomp)[decomp$p.value <= 0.01]

# Subset SingleCellExperiment
sce_filt <- sce[hvg,]
```

Regress out technical covariates
```{r}
data <- scale(t(logcounts(sce_filt)), center = T, scale = F)

# data <- apply(data, 2, function(x) {
#   # lm.out <- lm(formula=expr~ngenes+day, data=data.frame(expr=x, ngenes=rowSums(data>0), day=sce_filt$day));
#   lm.out <- lm(formula=expr~ngenes, data=data.frame(expr=x, ngenes=rowSums(data>0)));
#   residuals <- lm.out[["residuals"]]+lm.out[["coefficients"]][1]
# })
```

PCA
```{r}
reducedDim(sce_filt, "PCA") <- irlba::prcomp_irlba(data, n = 25)$x
reducedDim(sce, "PCA")  <- reducedDim(sce_filt, "PCA") 
```

```{r}
cor(colMeans(counts(sce_filt)>0), reducedDim(sce_filt,"PCA"))
```

t-SNE
```{r}
set.seed(42)
sce_filt <- runTSNE(sce_filt, dimred="PCA")
reducedDim(sce, "TSNE") <- reducedDim(sce_filt, "TSNE") 
```

UMAP
```{r}
set.seed(42)
sce_filt <- runUMAP(sce_filt, dimred="PCA", min_dist=0.7, n_neighbors=25)
reducedDim(sce, "UMAP") <- reducedDim(sce_filt, "UMAP") 
```

Plot

```{r}
to.plot <- reducedDim(sce_filt,"UMAP") %>% as.data.table %>% 
  .[,id_rna:=colnames(sce_filt)] %>%
  merge(sample_metadata,by="id_rna")
```

Colour by cell type
```{r}
p <- ggplot(to.plot, aes(x=V1,y=V2)) +
  geom_point(aes(fill=lineage10x_2), size=2.75, shape=21, color="black") +
  scale_fill_manual(values=opts$celltype.colors) +
  labs(x="", y="") +
  guides(fill = guide_legend(override.aes = list(size=3))) +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    axis.title = element_text(colour="black", size=rel(1.1)),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )

# pdf(paste0(io$outdir,"/rna_umap.pdf"), width=8, height=6.5, useDingbats = F)
print(p)
# dev.off()
```

Color by genotype
```{r}
p <- ggplot(to.plot, aes(x=V1,y=V2)) +
  geom_point(aes(fill=genotype), size=2.75, shape=21, color="black") +
  # scale_fill_manual(values=opts$celltype.colors) +
  labs(x="", y="") +
  guides(fill = guide_legend(override.aes = list(size=3))) +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    axis.title = element_text(colour="black", size=rel(1.1)),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )

# pdf(paste0(io$outdir,"/rna_umap.pdf"), width=8, height=6.5, useDingbats = F)
print(p)
# dev.off()
```


# Highlight marker genes

```{r}
marker_genes <- c(
  
  # Epiblast
  "Utf1","Slc7a3",
  
  # Primitive Streak
  "T","Fst",          
  
  # Mesoderm
  "Phlda2", "Mesp1", "Foxf1",
  
  # Endoderm
  "Sox17", "Foxa1",
  
  # Blood
  "Hbb-bh1", "Hba-a1", "Hba-x", "P2rx1"
  )

marker_genes <- c("Itga2b","Kdr")

for (i in marker_genes) {
  
  to.plot <- sce_filt@reducedDims$UMAP %>% as.data.table %>% .[,id_rna:=colnames(sce_filt)] %>%
    merge(sample_metadata) %>%
    .[,expr:=exprs(sce[i,])[1,]]
  
  p <- ggplot(to.plot, aes(x=V1, y=V2)) +
    # geom_point(aes(color=expr), size=0.4) +
    ggrastr::geom_point_rast(aes(color=expr, shape=genotype), size=1.25) +
    viridis::scale_color_viridis() +
    labs(x="", y="", title=i) +
    theme_classic() +
    theme(
      plot.title = element_text(hjust=0.5, size=rel(1.5)),
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      legend.position = "none",
      legend.direction = "horizontal"
    )

  # pdf(sprintf("%s/%s_umap.pdf",io$outdir,i), width=2.3, height=2.3, useDingbats = F)
  print(p)
  # dev.off()
}
```

